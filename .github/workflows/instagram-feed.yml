name: Update Instagram previews

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *" # daily 03:17 UTC

concurrency:
  group: instagram-previews
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install instaloader

      - name: Download latest posts (public profile)
        env:
          IG_PROFILE: rs.expert
        run: |
          set -e
          mkdir -p assets/ig

          # Instaloader downloads posts into assets/ig/<profile>/
          # --count limits how many posts to fetch
          instaloader \
            --no-metadata-json \
            --no-compress-json \
            --dirname-pattern "assets/ig/${IG_PROFILE}" \
            --filename-pattern "{date_utc}_UTC_{shortcode}" \
            --quiet \
            --fast-update \
            --count 18 \
            profile "${IG_PROFILE}" || true

      - name: Build data/instagram.json
        env:
          IG_PROFILE: rs.expert
          MAX_ITEMS: "50"
        run: |
          python scripts/build_instagram.py

      - name: Commit & push
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/instagram.json assets/ig || true

          # Nothing to commit
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "chore: update instagram previews"

          # Rebase on latest main to avoid push rejection
          git pull --rebase origin main

          git push origin main
